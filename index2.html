<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Tóner Pro - Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-semibold mb-4 text-blue-800">Control de Tóner - Cloud</h1>

    <form id="formToner" class="grid grid-cols-1 md:grid-cols-6 gap-4 border-b pb-6">
      <input id="serie" required placeholder="Serie" class="border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none" />
      <select id="sede" required class="border rounded px-3 py-2">
        <option value="">Sede</option>
        <option>Cusco</option>
        <option>Anta</option>
        <option>Urcos</option>
        <option>Sicuani</option>
        <option>Yauri</option>
        <option>Urubamba</option>
        <option>Quillabamba</option>
      </select>
      <input id="area" placeholder="Área" class="border rounded px-3 py-2" />
      <select id="tipo" class="border rounded px-3 py-2">
        <option>Blanco y Negro</option>
        <option>Color - Cyan</option>
        <option>Color - Magenta</option>
        <option>Color - Yellow</option>
        <option>Color - Black</option>
      </select>

      <button id="btnGuardar" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded px-4 py-2 transition">
        Guardar
      </button>

      <button type="button" id="btnCancelar" class="bg-gray-400 text-white rounded px-4 py-2 hidden">
        Cancelar
      </button>
    </form>

    <div class="mt-6 flex flex-wrap gap-4 items-center bg-gray-50 p-4 rounded-lg">
      <label class="font-medium">Filtrar por Sede:</label>
      <select id="filtroSede" class="border rounded px-3 py-2">
        <option value="">Todas las sedes</option>
        <option>Cusco</option>
        <option>Anta</option>
        <option>Urcos</option>
        <option>Sicuani</option>
        <option>Yauri</option>
        <option>Urubamba</option>
        <option>Quillabamba</option>
      </select>

      <button id="btnToggleEntregados" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded transition ml-auto">
        Ver / Ocultar Entregados
      </button>
    </div>

    <div class="mt-6 overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-blue-600 text-white">
            <th class="border px-2 py-2 text-left">Serie</th>
            <th class="border px-2 py-2 text-left">Sede</th>
            <th class="border px-2 py-2 text-left">Área</th>
            <th class="border px-2 py-2 text-left">Tipo</th>
            <th class="border px-2 py-2 text-left">Fecha</th>
            <th class="border px-2 py-2 text-left">Estado</th>
            <th class="border px-2 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaToner" class="bg-white"></tbody>
      </table>
    </div>

    <div id="panelEntregados" class="mt-8 hidden border-t-2 border-dashed pt-6">
      <h2 class="text-xl font-bold mb-4 text-green-700">Historial de Tóner Entregados</h2>
      <table class="w-full border-collapse text-sm shadow-lg">
        <thead>
          <tr class="bg-green-600 text-white">
            <th class="border px-2 py-2 text-left">Serie</th>
            <th class="border px-2 py-2 text-left">Sede</th>
            <th class="border px-2 py-2 text-left">Área</th>
            <th class="border px-2 py-2 text-left">Tipo</th>
            <th class="border px-2 py-2 text-left">Fecha Entrega</th>
            <th class="border px-2 py-2 text-center">Acción</th>
          </tr>
        </thead>
        <tbody id="tablaEntregados" class="bg-green-50"></tbody>
      </table>
    </div>
  </div>

<script type="module">
  // 1. Firebase Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
    serverTimestamp, updateDoc, doc, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 2. Configuración
  const firebaseConfig = {
    apiKey: "AIzaSyDVM1lf_3iQNVE7VAhRt6QXq918ZueVuuw",
    authDomain: "tonner-b8bc3.firebaseapp.com",
    projectId: "tonner-b8bc3",
    storageBucket: "tonner-b8bc3.firebasestorage.app",
    messagingSenderId: "88846165558",
    appId: "1:88846165558:web:fc7e72a2765e8f5f1cda97"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const colRef = collection(db, "registros_toner");

  // DOM Elements
  const formToner = document.getElementById("formToner");
  const tabla = document.getElementById("tablaToner");
  const tablaEnt = document.getElementById("tablaEntregados");
  const btnCancelar = document.getElementById("btnCancelar");
  const filtroSede = document.getElementById("filtroSede");
  
  let editId = null;

  // --- HELPERS VISUALES ---
  const colorEstado = (e) => {
    if (e === "Solicitado") return "text-blue-600 font-bold";
    if (e === "Pendiente") return "text-orange-500 font-bold";
    return "text-green-600 font-bold";
  };

  const colorTipo = (t) => {
    if (t.includes("Cyan")) return "text-cyan-500 font-bold";
    if (t.includes("Magenta")) return "text-pink-500 font-bold";
    if (t.includes("Yellow")) return "text-yellow-500 font-bold";
    if (t.includes("Black")) return "text-gray-900 font-bold";
    return "font-medium";
  };

  // --- LÓGICA CORE ---

  // Guardar o Editar
  formToner.addEventListener("submit", async (e) => {
    e.preventDefault();
    const sedeVal = document.getElementById("sede").value;
    const estadoInicial = sedeVal === "Cusco" ? "Solicitado" : "Pendiente";

    const datos = {
      serie: document.getElementById("serie").value,
      sede: sedeVal,
      area: document.getElementById("area").value,
      tipo: document.getElementById("tipo").value,
      fechaActualizada: new Date().toLocaleString()
    };

    try {
      if (editId) {
        await updateDoc(doc(db, "registros_toner", editId), datos);
        editId = null;
        btnCancelar.classList.add("hidden");
        alert("Actualizado correctamente");
      } else {
        await addDoc(colRef, {
          ...datos,
          estado: estadoInicial,
          fechaCreado: serverTimestamp(),
          fechaEntrega: ""
        });
      }
      formToner.reset();
    } catch (err) { console.error(err); }
  });

  // Escuchar cambios en tiempo real
  onSnapshot(query(colRef, orderBy("fechaCreado", "desc")), (snapshot) => {
    tabla.innerHTML = "";
    tablaEnt.innerHTML = "";

    snapshot.docs.forEach(docSnap => {
      const r = docSnap.data();
      const id = docSnap.id;

      if (filtroSede.value && r.sede !== filtroSede.value) return;

      if (r.estado !== "Entregado") {
        renderPrincipal(r, id);
      } else {
        renderEntregados(r, id);
      }
    });
  });

  function renderPrincipal(r, id) {
    tabla.innerHTML += `
      <tr class="hover:bg-gray-50 transition">
        <td class="border px-2 py-2">${r.serie}</td>
        <td class="border px-2 py-2">${r.sede}</td>
        <td class="border px-2 py-2">${r.area}</td>
        <td class="border px-2 py-2 ${colorTipo(r.tipo)}">${r.tipo}</td>
        <td class="border px-2 py-2 text-xs">${r.fechaActualizada || '---'}</td>
        <td class="border px-2 py-2 ${colorEstado(r.estado)}">${r.estado}</td>
        <td class="border px-2 py-2 text-center space-x-1">
          ${r.sede === "Cusco" && r.estado === "Solicitado" ? 
            <button onclick="cambiarEstado('${id}', 'Pendiente')" class="bg-orange-400 text-white px-2 py-1 text-xs rounded shadow">A Pendiente</button> : ""}
          ${r.estado === "Pendiente" ? 
            <button onclick="entregarToner('${id}')" class="bg-green-600 text-white px-2 py-1 text-xs rounded shadow">Entregar</button> : ""}
          <button onclick="prepararEdicion('${id}', '${r.serie}', '${r.sede}', '${r.area}', '${r.tipo}')" class="bg-blue-500 text-white px-2 py-1 text-xs rounded shadow">Editar</button>
          <button onclick="borrarRegistro('${id}')" class="bg-red-600 text-white px-2 py-1 text-xs rounded shadow">Borrar</button>
        </td>
      </tr>`;
  }

  function renderEntregados(r, id) {
    const fechaE = r.fechaEntrega ? new Date(r.fechaEntrega).toLocaleString() : "---";
    tablaEnt.innerHTML += `
      <tr class="hover:bg-green-100">
        <td class="border px-2 py-2">${r.serie}</td>
        <td class="border px-2 py-2 font-semibold">${r.sede}</td>
        <td class="border px-2 py-2">${r.area}</td>
        <td class="border px-2 py-2 ${colorTipo(r.tipo)}">${r.tipo}</td>
        <td class="border px-2 py-2 text-xs font-mono">${fechaE}</td>
        <td class="border px-2 py-2 text-center">
          <button onclick="revertirEntrega('${id}', '${r.sede}')" class="bg-yellow-500 text-white px-2 py-1 text-xs rounded">Revertir</button>
        </td>
      </tr>`;
  }

  // --- FUNCIONES GLOBALES (Para los onclick) ---
  window.cambiarEstado = async (id, nuevoEstado) => {
    await updateDoc(doc(db, "registros_toner", id), { estado: nuevoEstado });
  };

  window.entregarToner = async (id) => {
    await updateDoc(doc(db, "registros_toner", id), { 
      estado: "Entregado", 
      fechaEntrega: new Date().getTime() 
    });
  };

  window.revertirEntrega = async (id, sede) => {
    const estadoRev = sede === "Cusco" ? "Solicitado" : "Pendiente";
    await updateDoc(doc(db, "registros_toner", id), { 
      estado: estadoRev, 
      fechaEntrega: "" 
    });
  };

  window.borrarRegistro = async (id) => {
    if (confirm("¿Mi king, seguro que quieres borrarlo?")) {
      await deleteDoc(doc(db, "registros_toner", id));
    }
  };

  window.prepararEdicion = (id, s, sd, a, t) => {
    editId = id;
    document.getElementById("serie").value = s;
    document.getElementById("sede").value = sd;
    document.getElementById("area").value = a;
    document.getElementById("tipo").value = t;
    btnCancelar.classList.remove("hidden");
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // UI Handlers
  document.getElementById("btnToggleEntregados").onclick = () => {
    document.getElementById("panelEntregados").classList.toggle("hidden");
  };

  btnCancelar.onclick = () => {
    editId = null;
    formToner.reset();
    btnCancelar.classList.add("hidden");
  };

  filtroSede.onchange = () => { /* onSnapshot detecta el filtro */ };

</script>
</body>
</html>
