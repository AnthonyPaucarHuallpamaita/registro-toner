
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Tóner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  updateDoc, deleteDoc, doc, query, where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  aapiKey: "AIzaSyAE6YrTjBNhMMN-EiaAmx3u1FdMo_DKjts",
  authDomain: "registro-de-toners.firebaseapp.com",
  projectId: "registro-de-toners",
  storageBucket: "registro-de-toners.firebasestorage.app",
  messagingSenderId: "676666281972",
  appId: "1:676666281972:web:698aba192c2c6185f933a1",
  measurementId: "G-LH1Y8DCRF9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
</script>

<body class="bg-gray-100 p-6">
  <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-semibold mb-4">Registro de Tóner</h1>

    <!-- FORMULARIO -->
    <form id="formToner" class="grid grid-cols-1 md:grid-cols-6 gap-4">
      <input id="serie" required placeholder="Serie" class="border rounded px-3 py-2" />
      <select id="sede" required class="border rounded px-3 py-2">
        <option value="">Sede</option>
        <option>Cusco</option>
        <option>Anta</option>
        <option>Urcos</option>
        <option>Sicuani</option>
        <option>Yauri</option>
        <option>Urubamba</option>
        <option>Quillabamba</option>
      </select>
      <input id="area" placeholder="Área" class="border rounded px-3 py-2" />
      <select id="tipo" class="border rounded px-3 py-2">
        <option>Blanco y Negro</option>
        <option>Color - Cyan</option>
        <option>Color - Magenta</option>
        <option>Color - Yellow</option>
        <option>Color - Black</option>
      </select>

      <button class="bg-blue-600 text-white rounded px-4 py-2">
        Guardar
      </button>

      <button type="button" id="btnCancelar"
        onclick="cancelarEdicion()"
        class="bg-gray-400 text-white rounded px-4 py-2 hidden">
        Cancelar
      </button>
    </form>

    <!-- FILTROS -->
    <div class="mt-6 flex gap-4">
      <select id="filtroSede" class="border rounded px-3 py-2">
        <option value="">Todas las sedes</option>
        <option>Cusco</option>
        <option>Anta</option>
        <option>Urcos</option>
        <option>Sicuani</option>
        <option>Yauri</option>
        <option>Urubamba</option>
        <option>Quillabamba</option>
      </select>

      <button onclick="toggleEntregados()"
        class="bg-gray-700 text-white px-4 py-2 rounded">
        Ver tóner entregados
      </button>
    </div>

    <!-- TABLA PRINCIPAL -->
    <div class="mt-6 overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2">Serie</th>
            <th class="border px-2">Sede</th>
            <th class="border px-2">Área</th>
            <th class="border px-2">Tipo</th>
            <th class="border px-2">Fecha</th>
            <th class="border px-2">Estado</th>
            <th class="border px-2">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaToner"></tbody>
      </table>
    </div>

    <!-- ENTREGADOS -->
    <div id="panelEntregados" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Tóner Entregados</h2>
      <table class="w-full border-collapse text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2">Serie</th>
            <th class="border px-2">Sede</th>
            <th class="border px-2">Área</th>
            <th class="border px-2">Tipo</th>
            <th class="border px-2">Fecha Entrega</th>
            <th class="border px-2">Acción</th>
          </tr>
        </thead>
        <tbody id="tablaEntregados"></tbody>
      </table>
    </div>
  </div>

<script>
let registros = [];
let editIndex = null;

const tabla = document.getElementById("tablaToner");
const tablaEnt = document.getElementById("tablaEntregados");
const btnCancelar = document.getElementById("btnCancelar");
const filtroSede = document.getElementById("filtroSede");

function colorEstado(e) {
  if (e === "Solicitado") return "text-blue-600 font-semibold";
  if (e === "Pendiente") return "text-yellow-600 font-semibold";
  return "text-green-600 font-semibold";
}

function colorTipo(t) {
  if (t.includes("Cyan")) return "text-cyan-600 font-semibold";
  if (t.includes("Magenta")) return "text-pink-600 font-semibold";
  if (t.includes("Yellow")) return "text-yellow-600 font-semibold";
  if (t.includes("Black")) return "text-gray-800 font-semibold";
  return "";
}

function toggleEntregados() {
  document.getElementById("panelEntregados").classList.toggle("hidden");
}

function render() {
  tabla.innerHTML = "";
  tablaEnt.innerHTML = "";

  registros.forEach((r, i) => {

    if (filtroSede.value && r.sede !== filtroSede.value) return;

    if (r.estado !== "Entregado") {
      tabla.innerHTML += `
        <tr>
          <td class="border px-2">${r.serie}</td>
          <td class="border px-2">${r.sede}</td>
          <td class="border px-2">${r.area}</td>
          <td class="border px-2 ${colorTipo(r.tipo)}">${r.tipo}</td>
          <td class="border px-2">${r.fecha}</td>
          <td class="border px-2 ${colorEstado(r.estado)}">${r.estado}</td>
          <td class="border px-2 space-x-1">
            ${r.sede === "Cusco" && r.estado === "Solicitado"
              ? `<button onclick="aPendiente(${i})"
                   class="bg-yellow-500 text-white px-2 py-1 text-xs rounded">
                   A Pendiente
                 </button>`
              : ""
            }
            ${r.estado === "Pendiente"
              ? `<button onclick="entregar(${i})"
                   class="bg-green-600 text-white px-2 py-1 text-xs rounded">
                   Entregar
                 </button>`
              : ""
            }
            <button onclick="editar(${i})"
              class="bg-blue-500 text-white px-2 py-1 text-xs rounded">
              Editar
            </button>
            <button onclick="eliminar(${i})"
              class="bg-red-600 text-white px-2 py-1 text-xs rounded">
              Eliminar
            </button>
          </td>
        </tr>`;
    } else {
      tablaEnt.innerHTML += `
        <tr>
          <td class="border px-2">${r.serie}</td>
          <td class="border px-2">${r.sede}</td>
          <td class="border px-2">${r.area}</td>
          <td class="border px-2 ${colorTipo(r.tipo)}">${r.tipo}</td>
          <td class="border px-2">${new Date(r.fechaEntrega).toLocaleString()}</td>
         <td class="border px-2">
  ${
    esIrreversible(r.fechaEntrega)
    ? `<span class="text-gray-400 text-xs font-semibold">Confirmado</span>`
    : `<button onclick="volverPendiente(${i})"
        class="bg-yellow-500 text-white px-2 py-1 text-xs rounded">
        Volver a Pendiente
      </button>`
  }
</td>

        </tr>`;
    }
  });
}

function esIrreversible(fechaEntrega) {
  const hoy = new Date();
  const entrega = new Date(fechaEntrega);

  hoy.setHours(0,0,0,0);
  entrega.setHours(0,0,0,0);

  return hoy > entrega; // true = ya pasó el día
}

function aPendiente(i) {
  registros[i].estado = "Pendiente";
  render();
}

function entregar(i) {
  registros[i].estado = "Entregado";
  registros[i].fechaEntrega = new Date(); // guardar Date real
  render();
}


function volverPendiente(i) {
  registros[i].estado = registros[i].sede === "Cusco" ? "Solicitado" : "Pendiente";
  registros[i].fechaEntrega = "";
  render();
}

function editar(i) {
  const r = registros[i];
  serie.value = r.serie;
  sede.value = r.sede;
  area.value = r.area;
  tipo.value = r.tipo;
  editIndex = i;
  btnCancelar.classList.remove("hidden");
}

function eliminar(i) {
  if (confirm("¿Eliminar este registro?")) {
    registros.splice(i, 1);
    render();
  }
}

function cancelarEdicion() {
  editIndex = null;
  formToner.reset();
  btnCancelar.classList.add("hidden");
}

formToner.addEventListener("submit", e => {
  e.preventDefault();

  const estadoInicial = sede.value === "Cusco" ? "Solicitado" : "Pendiente";

  if (editIndex !== null) {
    registros[editIndex] = {
      ...registros[editIndex],
      serie: serie.value,
      sede: sede.value,
      area: area.value,
      tipo: tipo.value,
      estado: estadoInicial
    };
    editIndex = null;
    btnCancelar.classList.add("hidden");
  } else {
    registros.unshift({
      serie: serie.value,
      sede: sede.value,
      area: area.value,
      tipo: tipo.value,
      fecha: new Date().toLocaleString(),
      estado: estadoInicial,
      fechaEntrega: ""
    });
  }

  formToner.reset();
  render();
});

filtroSede.addEventListener("change", render);
</script>
</body>
</html>
