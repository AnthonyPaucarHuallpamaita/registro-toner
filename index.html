<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de T√≥ner </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="assets/favicon.png" type="image/png">
 <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2049/2049678.png" type="image/png">
</head>
<!-- BOT√ìN STOCK VERTICAL -->
<button id="btnStock"
  class="fixed bottom-4 left-2 bg-blue-600 hover:bg-blue-700 text-white
         px-2 py-4 rounded-xl shadow-lg z-50"
  style="writing-mode: vertical-rl;">
  üì¶ Stock Cusco
</button>


<!-- PANEL STOCK CUSCO -->
<div id="stockCusco"
  class="fixed bottom-4 left-20 bg-white shadow-xl rounded-xl p-4 w-64 border
         hidden z-50 transform translate-x-20 opacity-0
         transition-all duration-300 ease-in-out">

  <h3 class="font-bold text-blue-700 mb-2 text-sm">
    üì¶ Stock T√≥ner ‚Äì Cusco
  </h3>

  <ul class="text-sm space-y-1">
    <li>üñ®Ô∏è Blanco y Negro: <b id="stk-bn">0</b></li>
    <li class="text-cyan-600">üîµ Cyan: <b id="stk-cyan">0</b></li>
    <li class="text-pink-600">üü£ Magenta: <b id="stk-magenta">0</b></li>
    <li class="text-yellow-500">üü° Yellow: <b id="stk-yellow">0</b></li>
    <li class="text-gray-900">‚ö´ Black: <b id="stk-black">0</b></li>
  </ul>
</div>
  
 
<body class="bg-gray-100 p-6">
  <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow p-6">

<header class="else-header">

  <!-- FONDO AZUL CON CORTE -->
  <div class="else-blue-section"></div>

  <!-- LOGO -->
  <img src="https://app.else.com.pe/PagoVisaInvitado/e1f1542d1adff4302532f5b825e6e229.png" class="else-logo" alt="Electro Sur Este">

  <!-- TITULO -->
  <h1 class="else-title">Registro de T√≥ner ELSE</h1>

  <!-- ONDAS -->
  <div class="else-wave">
    <div class="else-yellow-line"></div>
    <div class="else-blue-line"></div>
  </div>

</header>

     
    <form id="formToner" class="max-w-7xl mx-auto bg-white rounded-2xl shadow p-6">
      <input id="serie" required placeholder="Serie" class="border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none" />
      <select id="sede" required class="border rounded px-3 py-2">
        <option value="">Sede</option>
        <option>Cusco</option>
        <option>Anta</option>
        <option>Urcos</option>
        <option>Sicuani</option>
        <option>Yauri</option>
        <option>Urubamba</option>
        <option>Quillabamba</option>
        <option>Santoto</option>
        <option>Larapa</option>
        <option>Abancay</option>
        <option>Andahuaylas</option>
        
        
      </select>
      <input id="area" placeholder="√Årea" class="border rounded px-3 py-2" />
      <select id="tipo" class="border rounded px-3 py-2">
        <option>Blanco y Negro</option>
        <option>Color - Cyan</option>
        <option>Color - Magenta</option>
        <option>Color - Yellow</option>
        <option>Color - Black</option>
      </select>

      <button id="btnGuardar" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded px-4 py-2 transition">
        Guardar
      </button>

      <button type="button" id="btnCancelar" class="bg-gray-400 text-white rounded px-4 py-2 hidden">
        Cancelar
      </button>
    </form>

    <div class="mt-6 flex flex-wrap gap-4 items-center bg-gray-50 p-4 rounded-lg">
      <label class="font-medium">Filtrar por Sede:</label>
      <select id="filtroSede" class="border rounded px-3 py-2">
        <option value="">Todas las sedes</option>
        <option>Cusco</option>
        <option>Anta</option>
        <option>Urcos</option>
        <option>Sicuani</option>
        <option>Yauri</option>
        <option>Urubamba</option>
        <option>Quillabamba</option>
        <option>Santoto</option>
        <option>Larapa</option>
        <option>Abancay</option>
        <option>Andahuaylas</option>
      </select>

      <button id="btnToggleEntregados" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded transition ml-auto">
        Ver / Ocultar Entregados
      </button>
    </div>

    <div class="mt-6 overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-blue-600 text-white">
            <th class="border px-2 py-2 text-left">Serie</th>
            <th class="border px-2 py-2 text-left">Sede</th>
            <th class="border px-2 py-2 text-left">√Årea</th>
            <th class="border px-2 py-2 text-left">Tipo</th>
            <th class="border px-2 py-2 text-left">Fecha</th>
            <th class="border px-2 py-2 text-left">Estado</th>
            <th class="border px-2 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaToner" class="bg-white"></tbody>
      </table>
    </div>

    <div id="panelEntregados" class="mt-8 hidden border-t-2 border-dashed pt-6">
      <h2 class="text-xl font-bold mb-4 text-green-700">Historial de T√≥ner Entregados</h2>
      <table class="w-full border-collapse text-sm shadow-lg">
        <thead>
          <tr class="bg-green-600 text-white">
            <th class="border px-2 py-2 text-left">Serie</th>
            <th class="border px-2 py-2 text-left">Sede</th>
            <th class="border px-2 py-2 text-left">√Årea</th>
            <th class="border px-2 py-2 text-left">Tipo</th>
            <th class="border px-2 py-2 text-left">Fecha Entrega</th>
            <th class="border px-2 py-2 text-center">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tablaEntregados" class="bg-green-50"></tbody>
      </table>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
    serverTimestamp, updateDoc, doc, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

 const firebaseConfig = {
     apiKey: "AIzaSyAE6YrTjBNhMMN-EiaAmx3u1FdMo_DKjts",
  authDomain: "registro-de-toners.firebaseapp.com",
  projectId: "registro-de-toners",
  storageBucket: "registro-de-toners.firebasestorage.app",
  messagingSenderId: "676666281972",
  appId: "1:676666281972:web:698aba192c2c6185f933a1",
  measurementId: "G-LH1Y8DCRF9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const colRef = collection(db, "registro-de-toners");

  const formToner = document.getElementById("formToner");
  const tabla = document.getElementById("tablaToner");
  const tablaEnt = document.getElementById("tablaEntregados");
  const btnCancelar = document.getElementById("btnCancelar");
  const filtroSede = document.getElementById("filtroSede");
  
  let editId = null;
  let datosLocales = []; // Cache para filtrar sin consultar a Firebase cada vez

  const colorEstado = (e) => {
    if (e === "Solicitado") return "text-blue-600 font-bold";
    if (e === "Pendiente") return "text-orange-500 font-bold";
    return "text-green-600 font-bold";
  };

  const colorTipo = (t) => {
    if (t.includes("Cyan")) return "text-cyan-500 font-bold";
    if (t.includes("Magenta")) return "text-pink-500 font-bold";
    if (t.includes("Yellow")) return "text-yellow-500 font-bold";
    if (t.includes("Black")) return "text-gray-900 font-bold";
    return "font-medium";
  };

  // --- L√ìGICA DE RENDERIZADO Y FILTRO ---

  function renderizarTablas() {
    tabla.innerHTML = "";
    tablaEnt.innerHTML = "";
    const filtro = filtroSede.value;

    datosLocales.forEach(r => {
      // Aplicar filtro de sede
      if (filtro !== "" && r.sede !== filtro) return;

      if (r.estado !== "Entregado") {
        renderPrincipal(r, r.id);
      } else {
        renderEntregados(r, r.id);
      }
    });
  }

  // Escuchar cambios en Firebase
  onSnapshot(query(colRef, orderBy("fechaCreado", "desc")), (snapshot) => {
    datosLocales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderizarTablas();
  });

  // Escuchar cambios en el selector de filtro
  filtroSede.addEventListener("change", renderizarTablas);

  function renderPrincipal(r, id) {
    tabla.innerHTML += `
      <tr class="hover:bg-gray-50 transition">
        <td class="border px-2 py-2">${r.serie}</td>
        <td class="border px-2 py-2">${r.sede}</td>
        <td class="border px-2 py-2">${r.area}</td>
        <td class="border px-2 py-2 ${colorTipo(r.tipo)}">${r.tipo}</td>
        <td class="border px-2 py-2 text-xs">${r.fechaActualizada || '---'}</td>
        <td class="border px-2 py-2 ${colorEstado(r.estado)}">${r.estado}</td>
        <td class="border px-2 py-2 text-center space-x-1">
          ${r.sede === "Cusco" && r.estado === "Solicitado" ? 
            `<button onclick="cambiarEstado('${id}', 'Pendiente')" class="bg-orange-400 text-white px-2 py-1 text-xs rounded shadow">A Pendiente</button>` : ""}
          ${r.estado === "Pendiente" ? 
            `<button onclick="entregarToner('${id}')" class="bg-green-600 text-white px-2 py-1 text-xs rounded shadow">Entregar</button>` : ""}
          <button onclick="prepararEdicion('${id}', '${r.serie}', '${r.sede}', '${r.area}', '${r.tipo}')" class="bg-blue-500 text-white px-2 py-1 text-xs rounded shadow">Editar</button>
          <button onclick="borrarRegistro('${id}')" class="bg-red-600 text-white px-2 py-1 text-xs rounded shadow">Borrar</button>
        </td>
      </tr>`;
  }

  function renderEntregados(r, id) {
  const fechaE = new Date(r.fechaEntrega).toLocaleString("es-PE");

  let boton = "";

  if (!r.confirmado) {
    boton = `
      <button
        onclick="confirmarEntrega('${id}')"
        class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 text-xs rounded">
        Confirmar
      </button>
      <button
        onclick="revertirEntrega('${id}', '${r.sede}')"
        class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 text-xs rounded ml-1">
        Revertir
      </button>`;
  } else {
    boton = `
      <span class="text-gray-500 font-semibold text-xs">
        ‚úî Confirmado
      </span>`;
  }

  tablaEnt.innerHTML += `
    <tr>
      <td class="border px-2 py-2">${r.serie}</td>
      <td class="border px-2 py-2">${r.sede}</td>
      <td class="border px-2 py-2">${r.area}</td>
      <td class="border px-2 py-2">${r.tipo}</td>
      <td class="border px-2 py-2 text-xs">${fechaE}</td>
      <td class="border px-2 py-2 text-center">
        ${boton}
      </td>
    </tr>`;
}

window.confirmarEntrega = async (id) => {
  if (!confirm("¬øConfirmar entrega definitiva?")) return;

  await updateDoc(doc(db, "registro-de-toners", id), {
    confirmado: true,
    fechaConfirmacion: Date.now()
  });
};
window.revertirEntrega = async (id, sede) => {
  const ref = doc(db, "registro-de-toners", id);
  const snap = await getDoc(ref);

  if (snap.data().confirmado) {
    alert("‚õî La entrega ya fue confirmada");
    return;
  }

  const estadoRev = sede === "Cusco" ? "Solicitado" : "Pendiente";

  await updateDoc(ref, {
    estado: estadoRev,
    fechaEntrega: "",
    confirmado: false
  });
};



  // --- ACCIONES FORMULARIO ---

  formToner.addEventListener("submit", async (e) => {
    e.preventDefault();
    const sedeVal = document.getElementById("sede").value;
    const estadoInicial = sedeVal === "Cusco" ? "Solicitado" : "Pendiente";

    const datos = {
      serie: document.getElementById("serie").value,
      sede: sedeVal,
      area: document.getElementById("area").value,
      tipo: document.getElementById("tipo").value,
      fechaActualizada: new Date().toLocaleString()
    };

    try {
      if (editId) {
        await updateDoc(doc(db, "registro-de-toners", editId), datos);
        editId = null;
        btnCancelar.classList.add("hidden");
        alert("Actualizado correctamente");
      } else {
        await addDoc(colRef, {
          ...datos,
          estado: estadoInicial,
          fechaCreado: serverTimestamp(),
          fechaEntrega: ""
        });
      }
      formToner.reset();
    } catch (err) { console.error(err); }
  });

  // --- FUNCIONES GLOBALES ---
  window.cambiarEstado = async (id, nuevoEstado) => {
    await updateDoc(doc(db, "registro-de-toners", id), { estado: nuevoEstado });
  };

  window.entregarToner = async (id) => {
    await updateDoc(doc(db, "registro-de-toners", id), { 
      estado: "Entregado", 
      fechaEntrega: new Date().getTime() 
    });
  };

  window.revertirEntrega = async (id, sede) => {
    const estadoRev = sede === "Cusco" ? "Solicitado" : "Pendiente";
    await updateDoc(doc(db, "registro-de-toners", id), { 
      estado: estadoRev, 
      fechaEntrega: "" 
    });
  };

  window.borrarRegistro = async (id) => {
    if (confirm("¬øMi king, seguro que quieres borrarlo?")) {
      await deleteDoc(doc(db, "registro-de-toners", id));
    }
  };

  window.prepararEdicion = (id, s, sd, a, t) => {
    editId = id;
    document.getElementById("serie").value = s;
    document.getElementById("sede").value = sd;
    document.getElementById("area").value = a;
    document.getElementById("tipo").value = t;
    btnCancelar.classList.remove("hidden");
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  document.getElementById("btnToggleEntregados").onclick = () => {
    document.getElementById("panelEntregados").classList.toggle("hidden");
  };

  btnCancelar.onclick = () => {
    editId = null;
    formToner.reset();
    btnCancelar.classList.add("hidden");
  };

  //MENU DE STOCK DESPLASANTE
const btnStock = document.getElementById("btnStock");
const panelStock = document.getElementById("stockCusco");

function mostrarPanel() {
  panelStock.classList.remove("hidden");

  // Forzamos repaint para que la animaci√≥n funcione
  requestAnimationFrame(() => {
    panelStock.classList.remove("translate-x-20", "opacity-0");
    panelStock.classList.add("translate-x-0", "opacity-100");
  });
}

function ocultarPanel() {
  panelStock.classList.add("translate-x-20", "opacity-0");
  panelStock.classList.remove("translate-x-0", "opacity-100");

  // Esperamos que termine la animaci√≥n
  setTimeout(() => {
    panelStock.classList.add("hidden");
  }, 300);
}

btnStock.addEventListener("click", (e) => {
  e.stopPropagation();

  if (panelStock.classList.contains("hidden")) {
    mostrarPanel();
  } else {
    ocultarPanel();
  }
});

// Click fuera ‚Üí se desliza y desaparece
document.addEventListener("click", (e) => {
  if (
    !panelStock.classList.contains("hidden") &&
    !panelStock.contains(e.target) &&
    !btnStock.contains(e.target)
  ) {
    ocultarPanel();
  }
});

</script>
</body>
</html>
